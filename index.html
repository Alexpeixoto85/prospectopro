<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Imobiliário de Luxo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS Incorporado para o sistema de arquivo único */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');

        :root {
            /* NOVA PALETA DE CORES */
            --primary-color: #D4AF37;       /* Dourado Clássico */
            --secondary-color: #2C3E50;     /* Azul Ardósia / Grafite */
            --accent-color: #3498DB;        /* Azul Vibrante para Ações */
            --background-color: #F4F6F9;    /* Cinza Muito Claro */
            --surface-color: #FFFFFF;       /* Branco */
            --text-color: #34495E;          /* Cinza Escuro */
            --text-light-color: #FFF;
            --danger-color: #E74C3C;        /* Vermelho Suave */
            --success-color: #2ECC71;      /* Verde Suave */
            --warning-color: #F39C12;       /* Laranja Suave */
            --font-family: 'Montserrat', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--secondary-color);
            color: var(--text-light-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            flex-shrink: 0;
        }

        .logo-container { display: flex; align-items: center; gap: 1rem; }
        #header-logo { max-height: 50px; border-radius: 5px; object-fit: contain; }
        .broker-info h1 { font-size: 1.2rem; font-weight: 600; }
        .broker-info p { font-size: 0.9rem; opacity: 0.8; }

        nav { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .nav-btn {
            background: none;
            border: none;
            color: var(--text-light-color);
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: var(--font-family);
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .nav-btn.active { background-color: var(--primary-color); color: var(--secondary-color); font-weight: 700; }
        .nav-btn i { margin-right: 8px; }

        .header-tools .calculator-link {
            color: var(--text-light-color);
            font-size: 1.5rem;
            text-decoration: none;
            transition: color 0.3s;
        }
        .header-tools .calculator-link:hover { color: var(--primary-color); }

        main {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .panel { display: none; animation: fadeIn 0.5s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], input[type="email"], select, textarea {
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            font-family: var(--font-family);
            flex-grow: 1;
        }
        .toolbar > input[type="text"] {
             min-width: 250px;
        }

        .btn-primary, .btn-secondary, .btn-danger, .btn-link, .btn-success {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            font-family: var(--font-family);
            text-align: center;
            white-space: nowrap;
        }
        .btn-primary { background-color: var(--primary-color); color: var(--secondary-color); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-light-color); }
        .btn-secondary:hover { filter: brightness(1.3); }
        .btn-danger { background-color: var(--danger-color); color: var(--text-light-color); }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-success { background-color: var(--success-color); color: var(--text-light-color); }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-link { background: none; color: var(--secondary-color); text-decoration: underline; padding: 0; }
        button i, a i { margin-right: 8px; }

        .table-container {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary-color); }
        tbody tr:hover { background-color: #f1f1f1; }
        .action-buttons { display:flex; gap: 0.8rem; }
        .action-buttons button, .action-buttons a { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--secondary-color); padding: 0; }
        .action-buttons button:hover, .action-buttons a:hover { color: var(--primary-color); }

        .funnel-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .funnel-filter-btn {
            background-color: #e0e0e0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .funnel-filter-btn.active { background-color: var(--secondary-color); color: white; }

        .settings-grid, .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        /* ===== SEÇÃO FINANCEIRA REESTRUTURADA ===== */
        .financial-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .financial-panel-header h2 { margin-bottom: 0; }
        .financial-panel-header .header-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .financial-grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }
        .financial-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            grid-column: span 12; /* Padrão para telas pequenas */
        }
        .financial-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            opacity: 0.9;
            font-weight: 600;
        }
        .metric-card-content { display: flex; align-items: center; gap: 1.5rem; }
        .metric-icon {
            font-size: 2.5rem; color: var(--primary-color); background-color: #fdf6e3;
            padding: 1rem; border-radius: 50%; width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
        }
        .metric-card .metric-value { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); line-height: 1.2; }
        .chart-card { min-height: 350px; display: flex; flex-direction: column; }
        .chart-card canvas { flex-grow: 1; }
        @media (min-width: 600px) { .financial-card.metric-card { grid-column: span 6; } }
        @media (min-width: 992px) {
            .financial-card.metric-card { grid-column: span 3; }
            .financial-card.chart-card { grid-column: span 6; }
            .financial-card.bi-card { grid-column: span 12; }
        }

        .settings-card, .dashboard-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .settings-card h3, .dashboard-card h3 { margin-bottom: 1rem; color: var(--secondary-color); }
        .settings-card input, .settings-card select { width: 100%; margin-bottom: 1rem; }
        .settings-card button { width: 100%; margin-top: 0.5rem; }
        .settings-card hr { border: 0; border-top: 1px solid #eee; margin: 1rem 0; }

        /* ===== ESTILOS PARA FUNIL ARRASTÁVEL ===== */
        #funnel-editor .stage-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 0.5rem;
            cursor: move; user-select: none;
            background-color: var(--surface-color);
        }
        #funnel-editor .stage-item.dragging { opacity: 0.5; background-color: #eaf2f8; }
        #funnel-editor input { margin: 0 0.5rem; flex-grow: 1; }
        #funnel-editor .stage-item button { background: none; border: none; color: var(--danger-color); cursor: pointer; }
        .drag-over-indicator { height: 2px; background: var(--accent-color); margin: 4px 0; border-radius: 1px; }

        /* ===== MODAIS ===== */
        .modal-container, .alert-modal-container {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-container.active, .alert-modal-container.active { display: flex; }
        .modal-content, .alert-modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem;
            border-radius: 10px; width: 90%;
            position: relative; animation: slideDown 0.5s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-content { max-width: 800px; }
        .alert-modal-content { max-width: 500px; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header, .alert-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2, .alert-modal-header h2 { margin-bottom: 0; border: none; }
        .modal-close-btn, .alert-modal-close-btn { font-size: 2rem; font-weight: bold; cursor: pointer; background: none; border: none; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .modal-footer { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .alert-modal-body p { margin-bottom: 1rem; line-height: 1.6; }
        .alert-modal-body i { color: var(--warning-color); margin-right: 10px; }

        /* Estilos para cards de BI e Fichas de Visualização */
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .metric-label { font-size: 1rem; opacity: 0.8; }
        .bi-insight { margin-top: 1rem; font-size: 0.9rem; }
        .bi-insight strong { color: var(--secondary-color); }
        .record-details h3, .report-section h3 { color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .record-details p { line-height: 1.8; margin-bottom: 0.5rem; }
        .record-details strong { color: #333; }
        .record-details a { color: var(--accent-color); font-size: 1.5rem; text-decoration: none; }
        
        /* Análise Financeira & Relatório de Funil */
        .analysis-result { background-color: #f8f9fa; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .analysis-result h4 { color: var(--secondary-color); }
        .analysis-result p { margin: 0.5rem 0; }
        .analysis-result .highlight-success { color: var(--success-color); font-weight: 700; font-size: 1.2rem; }
        .analysis-result .highlight-danger { color: var(--danger-color); font-weight: 700; font-size: 1.2rem; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .report-card { background: #f8f9fa; padding: 1rem; border-radius: 5px; text-align: center; }
        .report-card .value { font-size: 1.5rem; font-weight: 700; color: var(--secondary-color); }
        .report-card .label { font-size: 0.9rem; }
        .report-section ul { list-style-position: inside; padding-left: 10px; }

        /* ===== INÍCIO: ESTILOS DA AGENDA-CALENDÁRIO ===== */
        #calendar-container {
            background-color: var(--surface-color);
            padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-header button { background: none; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; padding: 0.5rem 1rem; }
        #month-year { font-size: 1.5rem; font-weight: 600; color: var(--secondary-color); }
        #calendar-grid, #weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        #weekdays div { font-weight: bold; padding: 0.5rem 0; color: var(--secondary-color); }
        .calendar-day {
            border: 1px solid #eee; min-height: 120px; padding: 5px;
            display: flex; flex-direction: column; cursor: pointer; transition: background-color 0.3s;
        }
        .calendar-day:hover { background-color: #f9f9f9; }
        .day-number { font-weight: bold; align-self: flex-start; }
        .calendar-day.other-month .day-number { opacity: 0.4; }
        .calendar-day.today .day-number {
            background-color: var(--primary-color); color: var(--secondary-color);
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; justify-content: center; align-items: center;
        }
        .events-container { margin-top: 5px; flex-grow: 1; overflow-y: auto; }
        .event-pill {
            font-size: 0.75rem; padding: 3px 5px; margin-bottom: 3px;
            border-radius: 3px; background-color: var(--secondary-color);
            color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .event-pill.completed { background-color: var(--success-color); text-decoration: line-through; }
        .event-pill.overdue { background-color: var(--danger-color); }
        .day-events-list .event-item {
            background-color: #fff; border-left: 5px solid var(--secondary-color);
            padding: 1rem; margin-bottom: 1rem; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .day-events-list .event-item.overdue { border-left-color: var(--danger-color); }
        .day-events-list .event-item.completed { text-decoration: line-through; opacity: 0.6; border-left-color: var(--success-color); }
        .day-events-list .birthday-item { border-left-color: #FFC107; }
        /* ===== FIM: ESTILOS DA AGENDA-CALENDÁRIO ===== */
        
        /* Ficha PDF */
        .pdf-ficha { position: absolute; left: -9999px; top: -9999px; background: white; padding: 20px; font-family: Arial, sans-serif; width: 210mm; color: #333; }
        .pdf-ficha h1 { text-align: center; color: var(--secondary-color); }
        .pdf-ficha h2 { color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; }
        .pdf-ficha p { line-height: 1.6; }
        .pdf-ficha a { color: var(--accent-color); font-size: 1.2rem; text-decoration: none; }
        
        /* Galeria de Imagens */
        #image-gallery-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #image-gallery-modal.active { display: flex; }
        #gallery-image-container { position: relative; width: 90%; height: 80%; }
        #gallery-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .gallery-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); color: white; border: none;
            font-size: 2.5rem; cursor: pointer; padding: 0 1rem;
        }
        #gallery-prev { left: 10px; }
        #gallery-next { right: 10px; }
        .gallery-tool {
            position: absolute; top: 15px;
            background: rgba(0,0,0,0.5); color: white; border: none;
            font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 5px;
        }
        #gallery-close { right: 15px; }
        #gallery-fullscreen { right: 70px; }
        #gallery-counter { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;}

        /* Thumbnails de upload */
        #prop-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .img-preview-container { position: relative; }
        .img-preview-container img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; }
        .remove-img-btn {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger-color); color: white;
            border: none; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }

        /* Gráfico do Funil */
        #funnel-chart-container {
            background-color: var(--surface-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 2rem;
        }
        #funnel-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 300px;
            border-left: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
            padding: 10px 0;
        }
        .funnel-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 15%;
            height: 100%;
            justify-content: flex-end;
        }
        .funnel-bar {
            width: 80%;
            background: linear-gradient(to top, var(--secondary-color), #566573);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease-out;
            position: relative;
            display: flex;
            justify-content: center;
        }
        .funnel-bar-label {
            position: absolute;
            top: -25px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .funnel-stage-name {
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img id="header-logo" src="https://via.placeholder.com/150x50.png?text=Sua+Logo" alt="Logo">
            <div class="broker-info">
                <h1 id="header-broker-name">Nome do Corretor</h1>
                <p id="header-broker-creci">CRECI: 00000</p>
            </div>
        </div>
        <nav>
            <button class="nav-btn active" data-panel="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="nav-btn" data-panel="clients"><i class="fas fa-users"></i> Clientes</button>
            <button class="nav-btn" data-panel="properties"><i class="fas fa-building"></i> Imóveis</button>
            <button class="nav-btn" data-panel="agenda"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button class="nav-btn" data-panel="financial"><i class="fas fa-chart-line"></i> Financeiro & BI</button>
            <button class="nav-btn" data-panel="settings"><i class="fas fa-cog"></i> Configurações</button>
        </nav>
        <div class="header-tools">
            <a href="https://alexpeixoto85.github.io/planoprofinal/" target="_blank" class="calculator-link" title="Calculadora Financeira">
                <i class="fas fa-calculator"></i>
            </a>
        </div>
    </header>

    <main>
        <div id="panel-dashboard" class="panel active">
            <h2>Dashboard</h2>
            <div id="dashboard-content" class="dashboard-grid"></div>
            <div id="funnel-chart-container">
                 <h3>Funil</h3>
                 <div id="funnel-chart"></div>
            </div>
        </div>

        <div id="panel-clients" class="panel">
            <h2>Gestão de Clientes</h2>
            <div class="toolbar">
                <input type="text" id="client-search" placeholder="Buscar por nome, contato ou CPF...">
                <select id="client-source-filter" style="flex-grow: 0; min-width: 180px;">
                    <option value="all">Todas as Origens</option>
                    <option value="imobiliária">Imobiliária</option>
                    <option value="plantão">Plantão</option>
                    <option value="construtora">Construtora</option>
                    <option value="patrocinado">Patrocinado</option>
                    <option value="ação de rua">Ação de Rua</option>
                    <option value="indicação">Indicação</option>
                </select>
                <button id="add-client-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Cliente</button>
                <button id="mass-whatsapp-btn" class="btn-secondary"><i class="fab fa-whatsapp"></i> Envio em Massa</button>
                <button id="export-clients-excel" class="btn-success"><i class="fas fa-file-excel"></i> Exportar Vista Atual</button>
            </div>
            <div id="funnel-filter-buttons" class="funnel-filters"></div>
            <div class="table-container">
                <table id="clients-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-clients"></th>
                            <th>Nome</th>
                            <th>Contato</th>
                            <th>Etapa do Funil</th>
                            <th>Origem</th>
                            <th>Valor do Imóvel</th>
                            <th>Comissão</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="panel-properties" class="panel">
            <h2>Gestão de Imóveis</h2>
            <div class="toolbar">
                <input type="text" id="property-search" placeholder="Buscar por nome ou localização...">
                <button id="add-property-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Imóvel</button>
                <button id="export-properties-excel" class="btn-success"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
            </div>
            <div class="table-container">
                <table id="properties-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Valor de Tabela</th>
                            <th>Valor de Avaliação</th>
                            <th>Localização</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-agenda" class="panel">
            <div class="toolbar">
                 <h2>Agenda de Compromissos</h2>
                 <button id="add-event-btn" class="btn-primary" style="margin-left: auto;"><i class="fas fa-plus"></i> Novo Compromisso</button>
            </div>
            <div id="calendar-container">
                <div id="calendar-header">
                    <button id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year"></h3>
                    <button id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="weekdays"></div>
                <div id="calendar-grid"></div>
            </div>
        </div>

        <div id="panel-financial" class="panel">
            <div class="financial-panel-header">
                <h2>Financeiro e Business Intelligence</h2>
                <div class="header-buttons">
                    <button id="view-funnel-report-btn" class="btn-secondary"><i class="fas fa-chart-pie"></i> Visualizar Relatório de Funil</button>
                    <button id="download-funnel-report-btn" class="btn-primary"><i class="fas fa-download"></i> Baixar Relatório (PDF)</button>
                </div>
            </div>
            <div id="financial-content" class="financial-grid-container">
                </div>
        </div>

        <div id="panel-settings" class="panel">
            <h2>Configurações</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Dados do Corretor</h3>
                    <input type="text" id="setting-broker-name" placeholder="Seu Nome Completo">
                    <input type="text" id="setting-broker-creci" placeholder="Seu CRECI">
                    <input type="text" id="setting-broker-phone" placeholder="Seu Telefone (com 55 e DDD)">
                    <label for="setting-logo-upload">Logo Marca:</label>
                    <input type="file" id="setting-logo-upload" accept="image/*">
                    <button id="save-broker-info" class="btn-primary">Salvar Dados</button>
                </div>
                <div class="settings-card">
                    <h3>Metas e Padrões</h3>
                    <label>Meta Mensal de Leads:</label>
                    <input type="number" id="setting-leads-goal" placeholder="Ex: 50">
                    <label>Meta de Faturamento Mensal (R$):</label>
                    <input type="number" id="setting-revenue-goal" placeholder="Ex: 50000">
                    <label>Comissão Padrão (%):</label>
                    <input type="number" id="setting-default-commission" placeholder="Ex: 5">
                     <button id="save-goals" class="btn-primary">Salvar Metas</button>
                </div>
                <div class="settings-card">
                    <h3>Gestão do Funil de Vendas (Arraste para reordenar)</h3>
                    <div id="funnel-editor"></div>
                    <div class="toolbar">
                        <input type="text" id="new-stage-name" placeholder="Nome da etapa">
                        <input type="number" id="new-stage-prob" placeholder="Prob. de Venda (%)">
                    </div>
                    <button id="add-stage-btn" class="btn-secondary">Adicionar Etapa</button>
                </div>
                <div class="settings-card">
                    <h3>Gerenciamento de Dados</h3>
                    <label>Importar Planilha (Clientes ou Imóveis):</label>
                    <div class="toolbar">
                        <input type="file" id="import-excel" accept=".xlsx">
                        <select id="import-type">
                            <option value="clients">Clientes</option>
                            <option value="properties">Imóveis</option>
                        </select>
                    </div>
                     <button id="import-btn" class="btn-secondary">Importar Planilha</button>
                    <button id="download-template-btn" class="btn-link">Baixar Modelo de Planilha</button>
                    <hr>
                    <button id="export-backup-btn" class="btn-secondary">Exportar Backup Completo (JSON)</button>
                    <label>Importar Backup (JSON):</label>
                    <input type="file" id="import-backup" accept=".json">
                    <button id="import-backup-btn" class="btn-secondary">Importar Backup</button>
                    <hr>
                    <button id="delete-duplicates-btn" class="btn-danger">Excluir Clientes Duplicados</button>
                    <button id="clear-system-btn" class="btn-danger">Limpar Todo o Sistema</button>
                </div>
            </div>
        </div>
    </main>
    
    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn-secondary">Cancelar</button>
                <button id="modal-save-btn" class="btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="alert-modal-container" class="alert-modal-container">
        <div class="alert-modal-content">
            <div class="alert-modal-header">
                <h2 id="alert-modal-title"></h2>
                <button id="alert-modal-close-btn" class="alert-modal-close-btn">&times;</button>
            </div>
            <div id="alert-modal-body" class="alert-modal-body"></div>
        </div>
    </div>
    
    <div id="pdf-generator" class="pdf-ficha"></div>
    
    <div id="image-gallery-modal">
        <div id="gallery-image-container">
            <img id="gallery-current-image" src="" alt="Imagem do Imóvel">
            <button id="gallery-prev" class="gallery-nav"><i class="fas fa-chevron-left"></i></button>
            <button id="gallery-next" class="gallery-nav"><i class="fas fa-chevron-right"></i></button>
            <button id="gallery-close" class="gallery-tool" title="Fechar"><i class="fas fa-times"></i></button>
            <button id="gallery-fullscreen" class="gallery-tool" title="Tela Cheia"><i class="fas fa-expand"></i></button>
            <div id="gallery-counter"></div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
    // =================================================================================
    // SCRIPT COMPLETO DO SISTEMA CRM (ARQUIVO ÚNICO)
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {

        // ==========================================
        // BANCO DE DADOS (INDEXEDDB COM DEXIE.JS)
        // ==========================================
        const dexieDb = new Dexie('CRMLuxoDatabase');
        dexieDb.version(1).stores({
            dataStore: 'id' // 'id' será a chave primária (usaremos um ID fixo: 1)
        });
    
        // ==========================================
        // ELEMENTOS DO DOM
        // ==========================================
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalFooter = document.querySelector('.modal-footer');

        const alertModalContainer = document.getElementById('alert-modal-container');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const alertModalBody = document.getElementById('alert-modal-body');

        let currentEditingId = null; 
        let currentEntityType = ''; 
        let tempPropertyImages = [];
        let currentCalendarDate = new Date();
    
        // ==========================================
        // ESTADO INICIAL E MANIPULAÇÃO DE DADOS
        // ==========================================
        let db = {};
    
        const defaultDb = {
            settings: {
                brokerName: 'Nome do Corretor',
                brokerCreci: 'CRECI: 00000',
                brokerPhone: '5582999998888',
                logoUrl: 'https://via.placeholder.com/150x50.png?text=Sua+Logo',
                goals: { leads: 50, revenue: 50000, },
                defaultCommission: 5,
            },
            funnelStages: [
                { id: 1, name: 'Lead', probability: 5 },
                { id: 2, name: 'Contato Realizado', probability: 20 },
                { id: 3, name: 'Visita Agendada', probability: 50 },
                { id: 4, name: 'Proposta Enviada', probability: 75 },
                { id: 5, name: 'Venda', probability: 100 },
            ],
            clients: [],
            properties: [],
            events: [],
            performanceSnapshots: [] // NOVO: Para análise histórica
        };
    
        const saveData = async () => {
            try {
                await dexieDb.dataStore.put({ id: 1, data: db });
            } catch (error) {
                console.error("Falha ao salvar os dados no IndexedDB:", error);
                alert("Ocorreu um erro crítico ao tentar salvar os dados. Suas alterações recentes podem não ter sido salvas.");
            }
        };

        const loadData = async () => {
            const oldData = localStorage.getItem('crmImobiliarioData');
            if (oldData) {
                console.log("Dados antigos encontrados no localStorage. Migrando para o IndexedDB...");
                try {
                    const parsedOldData = JSON.parse(oldData);
                    db = parsedOldData;
                    if (!db.performanceSnapshots) db.performanceSnapshots = []; // Garante compatibilidade
                    await saveData(); 
                    localStorage.removeItem('crmImobiliarioData');
                    console.log("Migração concluída com sucesso!");
                    alert("Seus dados foram migrados para um novo formato de armazenamento mais robusto para evitar o erro de 'armazenamento cheio'.");
                    return;
                } catch (e) {
                    console.error("Erro ao migrar dados do localStorage:", e);
                    alert("Houve um erro ao tentar migrar seus dados antigos. Carregando um estado padrão para evitar problemas.");
                    db = JSON.parse(JSON.stringify(defaultDb));
                    await saveData();
                    return;
                }
            }

            const storedData = await dexieDb.dataStore.get(1);
            if (storedData) {
                console.log("Dados carregados do IndexedDB.");
                db = storedData.data;
                 if (!db.performanceSnapshots) db.performanceSnapshots = []; // Garante compatibilidade
            } else {
                console.log("Nenhum dado encontrado. Inicializando com o padrão.");
                db = JSON.parse(JSON.stringify(defaultDb)); // Deep copy
                await saveData();
            }
        };
    
        // ==========================================
        // FUNÇÕES UTILITÁRIAS
        // ==========================================
        const formatCurrency = (value) => Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR') : ''; // Correção de fuso
        const getAgeInMonths = (birthdateString) => {
            if (!birthdateString) return null;
            const birthDate = new Date(birthdateString + 'T00:00:00'); // Correção de fuso
            const today = new Date();
            if (isNaN(birthDate.getTime())) return null;
            return (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
        };

        // ==========================================
        // NAVEGAÇÃO E RENDERIZAÇÃO GERAL
        // ==========================================
        const navButtons = document.querySelectorAll('.nav-btn');
        const panels = document.querySelectorAll('.panel');
    
        const switchPanel = (panelId) => {
            panels.forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${panelId}`)?.classList.add('active');
            navButtons.forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[data-panel="${panelId}"]`)?.classList.add('active');
            
            switch(panelId) {
                case 'dashboard': renderDashboard(); break;
                case 'clients': renderClientsTable(); renderFunnelFilters(); break;
                case 'properties': renderPropertiesTable(); break;
                case 'agenda': renderAgendaCalendar(); break;
                case 'financial': renderFinancialBI(); break;
                case 'settings': renderSettings(); break;
            }
        };
    
        navButtons.forEach(button => {
            button.addEventListener('click', () => switchPanel(button.dataset.panel));
        });
    
        const updateHeader = () => {
            document.getElementById('header-broker-name').textContent = db.settings.brokerName;
            document.getElementById('header-broker-creci').textContent = db.settings.brokerCreci;
            document.getElementById('header-logo').src = db.settings.logoUrl;
        };
    
        // ==========================================
        // MODAIS (GERAL, ALERTA)
        // ==========================================
        const openModal = (title, bodyHtml, entityType, id = null, showFooter = true) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = bodyHtml;
            currentEditingId = id;
            currentEntityType = entityType;
            modalFooter.style.display = showFooter ? 'flex' : 'none';
            modalContainer.classList.add('active');
            
            if (entityType === 'property') {
                document.getElementById('prop-images')?.addEventListener('change', handleImageSelection);
                document.getElementById('prop-image-previews')?.addEventListener('click', handleRemoveImage);
            }
        };
    
        const closeModal = () => {
            modalContainer.classList.remove('active');
            modalTitle.textContent = '';
            modalBody.innerHTML = '';
            currentEditingId = null;
            currentEntityType = '';
            tempPropertyImages = [];
        };
    
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
        
        const openAlertModal = (title, message) => {
            alertModalTitle.textContent = title;
            alertModalBody.innerHTML = message;
            alertModalContainer.classList.add('active');
        };
        const closeAlertModal = () => alertModalContainer.classList.remove('active');
        document.getElementById('alert-modal-close-btn').addEventListener('click', closeAlertModal);

        // ==========================================
        // SISTEMA DE ALERTA DE INICIALIZAÇÃO
        // ==========================================
        const checkStartupAlerts = () => {
            const firstStageId = db.funnelStages[0]?.id;
            const uncontactedLeads = firstStageId ? db.clients.filter(c => c.stageId === firstStageId).length : 0;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const pendingTasks = db.events.filter(e => {
                if (e.completed || !e.date) return false;
                const eventDate = new Date(e.date + 'T00:00:00');
                return eventDate < today;
            }).length;

            let alertMessage = '';
            if (uncontactedLeads > 0) {
                alertMessage += `<p><i class="fas fa-user-clock"></i> Você tem <strong>${uncontactedLeads} lead(s)</strong> na primeira etapa do funil aguardando contato.</p>`;
            }
            if (pendingTasks > 0) {
                alertMessage += `<p><i class="fas fa-exclamation-triangle"></i> Você tem <strong>${pendingTasks} tarefa(s) pendente(s)</strong> na sua agenda.</p>`;
            }

            if (alertMessage) {
                openAlertModal('Lembretes Importantes', alertMessage);
            }
        };

        // ==========================================
        // GESTÃO DE CLIENTES
        // ==========================================
        const getClientFormHtml = (client = {}) => {
            const funnelOptions = db.funnelStages.map(stage => 
                `<option value="${stage.id}" ${client.stageId == stage.id ? 'selected' : ''}>${stage.name}</option>`
            ).join('');

            const propertyOptions = db.properties.map(prop =>
                `<option value="${prop.id}" ${client.propertyId == prop.id ? 'selected' : ''}>${prop.name} - ${formatCurrency(prop.listPrice)}</option>`
            ).join('');
            
            const leadSources = ["imobiliária", "plantão", "construtora", "patrocinado", "ação de rua", "indicação"];
            const sourceOptions = leadSources.map(source => 
                `<option value="${source}" ${client.leadSource === source ? 'selected' : ''}>${source.charAt(0).toUpperCase() + source.slice(1)}</option>`
            ).join('');
            
            return `
                <div class="form-grid">
                    <div class="form-group"><label for="client-name">Nome Completo</label><input type="text" id="client-name" value="${client.name || ''}"></div>
                    <div class="form-group"><label for="client-phone">Contato (WhatsApp)</label><input type="text" id="client-phone" value="${client.phone || ''}"></div>
                    <div class="form-group"><label for="client-email">E-mail</label><input type="email" id="client-email" value="${client.email || ''}"></div>
                    <div class="form-group"><label for="client-cpf">CPF</label><input type="text" id="client-cpf" value="${client.cpf || ''}"></div>
                    <div class="form-group"><label for="client-birthdate">Data de Nascimento</label><input type="date" id="client-birthdate" value="${client.birthdate || ''}"></div>
                    <div class="form-group"><label for="client-income">Renda (R$)</label><input type="number" id="client-income" value="${client.income || ''}"></div>
                    <div class="form-group"><label for="client-property-value">Valor do Imóvel Pretendido (R$)</label><input type="number" id="client-property-value" value="${client.propertyValue || ''}"></div>
                    <div class="form-group"><label for="client-commission">Comissão Personalizada (%)</label><input type="number" id="client-commission" placeholder="Padrão: ${db.settings.defaultCommission}%" value="${client.commission || ''}"></div>
                    <div class="form-group"><label for="client-stageId">Etapa do Funil</label><select id="client-stageId">${funnelOptions}</select></div>
                    <div class="form-group"><label for="client-lead-source">Origem do Lead</label><select id="client-lead-source"><option value="">Selecione...</option>${sourceOptions}</select></div>
                    <div class="form-group full-width"><label for="client-propertyId">Imóvel de Interesse</label><select id="client-propertyId"><option value="">Nenhum</option>${propertyOptions}</select></div>
                    <div class="form-group full-width"><label for="client-notes">Observações</label><textarea id="client-notes">${client.notes || ''}</textarea></div>
                </div>
            `;
        };
    
        document.getElementById('add-client-btn').addEventListener('click', () => {
            openModal('Cadastrar Novo Cliente', getClientFormHtml(), 'client');
        });
    
        const renderClientsTable = (filter = '', stageFilter = null, sourceFilter = null) => {
            const tbody = document.querySelector('#clients-table tbody');
            tbody.innerHTML = '';
            
            let filteredClients = db.clients.filter(c => 
                (c.name || '').toLowerCase().includes(filter.toLowerCase()) || 
                (c.phone || '').includes(filter) || 
                (c.cpf || '').includes(filter)
            );
            
            if (stageFilter) {
                filteredClients = filteredClients.filter(c => c.stageId == stageFilter);
            }

            if (sourceFilter) {
                filteredClients = filteredClients.filter(c => c.leadSource === sourceFilter);
            }
    
            if (filteredClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">Nenhum cliente encontrado.</td></tr>'; return;
            }
    
            filteredClients.forEach(client => {
                const stage = db.funnelStages.find(s => s.id === client.stageId);
                const property = db.properties.find(p => p.id == client.propertyId);
                const propertyValue = property ? property.listPrice : client.propertyValue;
                const commission = client.commission || db.settings.defaultCommission;
                const commissionValue = (propertyValue * commission) / 100;
                
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="client-checkbox" data-phone="${client.phone}"></td>
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td>${stage ? stage.name : 'N/A'}</td>
                        <td>${client.leadSource || 'N/A'}</td>
                        <td>${formatCurrency(propertyValue)}</td>
                        <td>${formatCurrency(commissionValue)} (${commission}%)</td>
                        <td class="action-buttons">
                            <button title="Visualizar Ficha" data-action="view" data-id="${client.id}"><i class="fas fa-eye"></i></button>
                            <button title="Análise de Financiamento" data-action="analyze" data-id="${client.id}"><i class="fas fa-search-dollar"></i></button>
                            <button title="Gerar Ficha PDF" data-action="pdf" data-id="${client.id}"><i class="fas fa-file-pdf"></i></button>
                            <a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}" target="_blank" title="Contatar"><i class="fab fa-whatsapp"></i></a>
                            <button title="Editar" data-action="edit" data-id="${client.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${client.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        const triggerClientTableRender = () => {
            const searchValue = document.getElementById('client-search').value;
            const stageValue = document.querySelector('.funnel-filter-btn.active')?.dataset.stageId;
            const sourceValue = document.getElementById('client-source-filter').value;
            renderClientsTable(
                searchValue,
                stageValue === 'all' ? null : stageValue,
                sourceValue === 'all' ? null : sourceValue
            );
        };

        document.getElementById('client-search').addEventListener('input', triggerClientTableRender);
        document.getElementById('client-source-filter').addEventListener('change', triggerClientTableRender);
    
        document.querySelector('#clients-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button, a');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
    
            if (action === 'edit') {
                const client = db.clients.find(c => c.id == id);
                openModal('Editar Cliente', getClientFormHtml(client), 'client', id);
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o cliente?`)) {
                    db.clients = db.clients.filter(c => c.id != id);
                    saveData();
                    triggerClientTableRender();
                }
            } else if (action === 'pdf') {
                generateClientPDF(id);
            } else if (action === 'analyze') {
                handleFinancingAnalysis(id);
            } else if (action === 'view') {
                 const clientHtml = getClientDetailsHtml(id);
                 openModal(`Ficha de ${db.clients.find(c => c.id == id).name}`, `<div class="record-details">${clientHtml}</div>`, 'view', null, false);
            }
        });
        
        const renderFunnelFilters = () => {
            const container = document.getElementById('funnel-filter-buttons');
            container.innerHTML = '<button class="funnel-filter-btn active" data-stage-id="all">Todos</button>';
            db.funnelStages.forEach(stage => {
                container.innerHTML += `<button class="funnel-filter-btn" data-stage-id="${stage.id}">${stage.name}</button>`;
            });
        };

        document.getElementById('funnel-filter-buttons').addEventListener('click', e => {
            if(e.target.tagName === 'BUTTON'){
                document.querySelectorAll('.funnel-filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                triggerClientTableRender();
            }
        });

        document.getElementById('mass-whatsapp-btn').addEventListener('click', () => {
            const selected = document.querySelectorAll('.client-checkbox:checked');
            if (selected.length === 0) {
                alert('Selecione pelo menos um cliente para enviar a mensagem.');
                return;
            }
            const message = prompt('Digite a mensagem que deseja enviar (use [nome] para personalizar):', 'Olá, [nome]! Tudo bem?');
            if (!message) return;

            selected.forEach(checkbox => {
                const phone = (checkbox.dataset.phone || '').replace(/\D/g, '');
                const client = db.clients.find(c => (c.phone || '').replace(/\D/g, '') === phone);
                if (client) {
                    const personalizedMessage = message.replace(/\[nome\]/gi, client.name.split(' ')[0]);
                    const url = `https://wa.me/${phone}?text=${encodeURIComponent(personalizedMessage)}`;
                    window.open(url, '_blank');
                }
            });
        });
        
        document.getElementById('select-all-clients').addEventListener('change', e => {
            document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
        
        // ==========================================
        // GESTÃO DE IMÓVEIS
        // ==========================================
        const getPropertyFormHtml = (prop = {}) => {
            tempPropertyImages = prop.images ? [...prop.images] : [];
            const incomeText = (prop.listPrice && prop.listPrice > 0) 
                ? `(Renda Mínima Estimada: ${formatCurrency(calculateMinimumIncomeForProperty(prop.listPrice))})`
                : '';
            
            return `
                <div class="form-grid">
                    <div class="form-group"><label for="prop-name">Nome do Imóvel/Empreendimento</label><input type="text" id="prop-name" value="${prop.name || ''}"></div>
                    <div class="form-group"><label for="prop-location">Localização</label><input type="text" id="prop-location" value="${prop.location || ''}"></div>
                    <div class="form-group"><label for="prop-list-price">Valor de Tabela (R$) ${incomeText}</label><input type="number" id="prop-list-price" value="${prop.listPrice || ''}"></div>
                    <div class="form-group"><label for="prop-eval-price">Valor de Avaliação (R$)</label><input type="number" id="prop-eval-price" value="${prop.evalPrice || ''}"></div>
                    <div class="form-group"><label for="prop-delivery-date">Data de Entrega</label><input type="date" id="prop-delivery-date" value="${prop.deliveryDate || ''}"></div>
                    <div class="form-group"><label for="prop-link">Link (Tour Virtual, Site)</label><input type="text" id="prop-link" value="${prop.link || ''}"></div>
                    <div class="form-group full-width"><label for="prop-description">Descrição</label><textarea id="prop-description">${prop.description || ''}</textarea></div>
                    <div class="form-group full-width">
                        <label for="prop-images">Fotos do Imóvel (até 10)</label>
                        <input type="file" id="prop-images" multiple accept="image/*">
                        <div id="prop-image-previews">
                            ${(prop.images || []).map((imgData, index) => `
                                <div class="img-preview-container">
                                    <img src="${imgData}" alt="Pré-visualização ${index + 1}">
                                    <button class="remove-img-btn" data-index="${index}">&times;</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderPropertyPreviews = () => {
            const container = document.getElementById('prop-image-previews');
            if (!container) return;
            container.innerHTML = tempPropertyImages.map((imgData, index) => `
                <div class="img-preview-container">
                    <img src="${imgData}" alt="Pré-visualização ${index + 1}">
                    <button class="remove-img-btn" data-index="${index}">&times;</button>
                </div>
            `).join('');
        };

        const handleImageSelection = (event) => {
            const files = event.target.files;
            if (!files) return;
            
            const totalImages = tempPropertyImages.length + files.length;
            if (totalImages > 10) {
                alert('Você pode enviar no máximo 10 imagens.');
                return;
            }

            const imagePromises = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                imagePromises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 1024;
                            const scaleSize = (img.width > MAX_WIDTH) ? MAX_WIDTH / img.width : 1;
                            canvas.width = img.width * scaleSize;
                            canvas.height = img.height * scaleSize;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.75); 
                            resolve(compressedDataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));
            }

            Promise.all(imagePromises).then(images => {
                tempPropertyImages = [...tempPropertyImages, ...images];
                renderPropertyPreviews();
            }).catch(error => {
                console.error("Erro ao processar imagens:", error);
                alert("Ocorreu um erro ao carregar e comprimir as imagens.");
            });
        };
        
        const handleRemoveImage = (event) => {
            if (event.target.classList.contains('remove-img-btn')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempPropertyImages.splice(index, 1);
                renderPropertyPreviews();
            }
        };

        document.getElementById('add-property-btn').addEventListener('click', () => {
            openModal('Cadastrar Novo Imóvel', getPropertyFormHtml(), 'property');
        });

        const renderPropertiesTable = (filter = '') => {
            const tbody = document.querySelector('#properties-table tbody');
            tbody.innerHTML = '';
            const filtered = db.properties.filter(p => 
                (p.name || '').toLowerCase().includes(filter.toLowerCase()) || 
                (p.location || '').toLowerCase().includes(filter.toLowerCase())
            );
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Nenhum imóvel encontrado.</td></tr>'; return;
            }
            filtered.forEach(prop => {
                tbody.innerHTML += `
                    <tr>
                        <td>${prop.name}</td>
                        <td>${formatCurrency(prop.listPrice)}</td>
                        <td>${formatCurrency(prop.evalPrice)}</td>
                        <td>${prop.location}</td>
                        <td class="action-buttons">
                             ${prop.images && prop.images.length > 0 ? `<button title="Ver Fotos" data-action="gallery" data-id="${prop.id}"><i class="fas fa-camera"></i></button>` : ''}
                            <button title="Visualizar Ficha" data-action="view" data-id="${prop.id}"><i class="fas fa-eye"></i></button>
                            <button title="Gerar Ficha PDF" data-action="pdf" data-id="${prop.id}"><i class="fas fa-file-pdf"></i></button>
                            <button title="Editar" data-action="edit" data-id="${prop.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${prop.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        document.getElementById('property-search').addEventListener('input', e => renderPropertiesTable(e.target.value));

        document.querySelector('#properties-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
    
            if (action === 'edit') {
                const prop = db.properties.find(p => p.id == id);
                openModal('Editar Imóvel', getPropertyFormHtml(prop), 'property', id);
            }
            if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o imóvel?`)) {
                    db.properties = db.properties.filter(p => p.id != id);
                    saveData();
                    renderPropertiesTable();
                }
            }
             if (action === 'pdf') {
                generatePropertyPDF(id);
            }
            if (action === 'gallery') {
                openImageGallery(id);
            }
            if (action === 'view') {
                 const propHtml = getPropertyDetailsHtml(id);
                 openModal(`Ficha de ${db.properties.find(p => p.id == id).name}`, `<div class="record-details">${propHtml}</div>`, 'view', null, false);
            }
        });
        
        // ==========================================
        // GALERIA DE IMAGENS
        // ==========================================
        const galleryModal = document.getElementById('image-gallery-modal');
        const galleryImage = document.getElementById('gallery-current-image');
        const galleryContainer = document.getElementById('gallery-image-container');
        const galleryCounter = document.getElementById('gallery-counter');
        let currentImageIndex = 0;
        let currentImages = [];

        const openImageGallery = (propertyId) => {
            const property = db.properties.find(p => p.id == propertyId);
            if (!property || !property.images || property.images.length === 0) return;
            
            currentImages = property.images;
            currentImageIndex = 0;
            updateGalleryView();
            galleryModal.classList.add('active');
        };

        const updateGalleryView = () => {
            galleryImage.src = currentImages[currentImageIndex];
            galleryCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        };

        const changeImage = (direction) => {
            currentImageIndex += direction;
            if (currentImageIndex >= currentImages.length) { currentImageIndex = 0; }
            if (currentImageIndex < 0) { currentImageIndex = currentImages.length - 1; }
            updateGalleryView();
        };
        
        document.getElementById('gallery-next').addEventListener('click', () => changeImage(1));
        document.getElementById('gallery-prev').addEventListener('click', () => changeImage(-1));
        document.getElementById('gallery-close').addEventListener('click', () => galleryModal.classList.remove('active'));
        document.getElementById('gallery-fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                galleryContainer.requestFullscreen().catch(err => {
                    alert(`Erro ao entrar em tela cheia: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        // ==========================================
        // GESTÃO DA AGENDA (CALENDÁRIO)
        // ==========================================
        const getEventFormHtml = (event = {}, date = '') => {
            const clientOptions = db.clients.map(client => 
                `<option value="${client.id}" ${event.clientId == client.id ? 'selected' : ''}>${client.name}</option>`
            ).join('');

            return `
                <div class="form-grid">
                    <div class="form-group"><label for="event-title">Título</label><input type="text" id="event-title" value="${event.title || ''}"></div>
                    <div class="form-group"><label for="event-client">Associar ao Cliente (Opcional)</label><select id="event-client"><option value="">Nenhum</option>${clientOptions}</select></div>
                    <div class="form-group"><label for="event-date">Data</label><input type="date" id="event-date" value="${event.date || date}"></div>
                    <div class="form-group"><label for="event-time">Hora</label><input type="time" id="event-time" value="${event.time || ''}"></div>
                    <div class="form-group full-width"><label for="event-description">Descrição</label><textarea id="event-description">${event.description || ''}</textarea></div>
                </div>
            `;
        };

        document.getElementById('add-event-btn').addEventListener('click', () => {
            const today = new Date().toISOString().slice(0, 10);
            openModal('Novo Compromisso', getEventFormHtml({}, today), 'event');
        });

        const renderAgendaCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('month-year');
            const weekdaysEl = document.getElementById('weekdays');

            grid.innerHTML = '';
            weekdaysEl.innerHTML = '';
            
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            
            monthYearEl.textContent = currentCalendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => weekdaysEl.innerHTML += `<div>${day}</div>`);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().slice(0, 10);

                const isToday = date.toDateString() === today.toDateString();
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if(isToday) dayDiv.classList.add('today');
                dayDiv.dataset.date = dateString;
                dayDiv.innerHTML = `<div class="day-number">${day}</div><div class="events-container"></div>`;
                
                const eventsOnThisDay = db.events.filter(e => e.date === dateString);
                const eventsContainer = dayDiv.querySelector('.events-container');

                eventsOnThisDay.forEach(event => {
                    const eventPill = document.createElement('div');
                    eventPill.className = 'event-pill';
                    eventPill.textContent = event.title;
                    eventPill.dataset.eventId = event.id;
                    if(event.completed) eventPill.classList.add('completed');
                    const eventDateTime = new Date(`${event.date}T${event.time || '23:59:59'}`);
                    if(!event.completed && eventDateTime < today) eventPill.classList.add('overdue');
                    eventsContainer.appendChild(eventPill);
                });

                grid.appendChild(dayDiv);
            }
        };

        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderAgendaCalendar();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderAgendaCalendar();
        });

        document.getElementById('calendar-grid').addEventListener('click', e => {
            const dayElement = e.target.closest('.calendar-day');
            if (!dayElement) return;

            const date = dayElement.dataset.date;
            
            // Se clicou num evento
            if(e.target.classList.contains('event-pill')) {
                const eventId = e.target.dataset.eventId;
                const event = db.events.find(ev => ev.id == eventId);
                openModal('Editar Compromisso', getEventFormHtml(event), 'event', eventId);
                return;
            }

            // Se clicou no dia para ver a lista ou adicionar novo
            const eventsOnDay = db.events.filter(ev => ev.date === date);
            const clientsBirthday = db.clients.filter(client => {
                if (!client.birthdate) return false;
                const birthDate = new Date(client.birthdate + 'T00:00:00');
                const clickedDate = new Date(date + 'T00:00:00');
                return birthDate.getDate() === clickedDate.getDate() && birthDate.getMonth() === clickedDate.getMonth();
            });

            if (eventsOnDay.length === 0 && clientsBirthday.length === 0) {
                 openModal('Novo Compromisso', getEventFormHtml({}, date), 'event');
            } else {
                openDayEventsModal(date, eventsOnDay, clientsBirthday);
            }
        });
        
        const openDayEventsModal = (date, events, birthdays) => {
            let content = '<div class="day-events-list">';
            const now = new Date();
            
            if (birthdays.length > 0) {
                content += '<h3><i class="fas fa-birthday-cake"></i> Aniversariantes</h3>';
                birthdays.forEach(client => {
                    content += `<div class="birthday-item event-item">Parabéns para <strong>${client.name}</strong>! <a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}?text=Olá, ${client.name.split(' ')[0]}! Parabéns pelo seu aniversário!" target="_blank"><i class="fab fa-whatsapp"></i> Enviar mensagem</a></div>`;
                });
            }

            if (events.length > 0) {
                content += '<h3>Compromissos</h3>';
                events.sort((a,b) => (a.time || '').localeCompare(b.time || ''));

                events.forEach(event => {
                    const client = db.clients.find(c => c.id == event.clientId);
                    const eventDateTime = new Date(`${event.date}T${event.time || '00:00:00'}`);
                    const isOverdue = !event.completed && eventDateTime < now;
                    
                    content += `
                        <div class="event-item ${event.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${event.id}">
                            <h4>${event.title} - ${event.time || 'horário não definido'}</h4>
                            <p>${event.description}</p>
                            ${client ? `<p><strong>Cliente:</strong> ${client.name}</p>` : ''}
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button title="${event.completed ? 'Marcar como não concluído' : 'Marcar como concluído'}" data-action="toggle-complete"><i class="fas fa-check-circle"></i></button>
                                <button title="Editar" data-action="edit"><i class="fas fa-edit"></i></button>
                                <button title="Excluir" data-action="delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
            content += '</div>';
            openModal(`Eventos de ${formatDate(date)}`, content, 'day-view', null, false);
        };
        
        modalBody.addEventListener('click', e => {
            if(currentEntityType !== 'day-view') return;
            
            const button = e.target.closest('button');
            if (!button) return;
            
            const eventItem = button.closest('.event-item');
            const id = eventItem.dataset.id;
            const action = button.dataset.action;
            const event = db.events.find(ev => ev.id == id);
            
            if (action === 'edit') {
                closeModal();
                openModal('Editar Compromisso', getEventFormHtml(event), 'event', id);
            } else if (action === 'delete') {
                if (confirm('Deseja excluir este compromisso?')) {
                    db.events = db.events.filter(ev => ev.id != id);
                    saveData();
                    closeModal();
                    renderAgendaCalendar();
                }
            } else if (action === 'toggle-complete') {
                event.completed = !event.completed;
                saveData();
                closeModal();
                renderAgendaCalendar();
            }
        });
        
        // ==========================================
        // CÁLCULOS E ANÁLISE DE FINANCIAMENTO
        // ==========================================
        const calculateMinimumIncomeForProperty = (propertyPrice) => {
            if (!propertyPrice || propertyPrice <= 0) return 0;
            const P = propertyPrice * 0.80; 
            const r = (1 + 0.05)**(1/12) - 1; 
            const n = 420; 
            const pmt = (P * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
            const requiredIncome = pmt / 0.30;
            return requiredIncome;
        };

        const calculateFinancing = (client, property) => {
            if (!client || !property || !client.income || !client.birthdate || !property.listPrice) {
                return { error: 'Dados insuficientes. Verifique se o cliente possui renda, data de nascimento e um imóvel de interesse com valor cadastrado.' };
            }

            const clientAgeInMonths = getAgeInMonths(client.birthdate);
            if (clientAgeInMonths === null) {
                return { error: 'Data de nascimento do cliente é inválida.' };
            }
            
            const MAX_AGE_MONTHS = 966; // 80 anos e 6 meses
            const MAX_TERM_MONTHS = 420; // 35 anos
            const INTEREST_RATE_YEARLY = 0.05;
            const MAX_LOAN_TO_VALUE = 0.80; // 80%
            const MAX_DEBT_TO_INCOME = 0.30; // 30%

            const maxTermByAge = MAX_AGE_MONTHS - clientAgeInMonths;
            if (maxTermByAge <= 0) {
                return { error: 'Cliente acima da idade máxima para financiamento.' };
            }

            const finalTerm = Math.min(MAX_TERM_MONTHS, maxTermByAge);
            const monthlyInterestRate = (1 + INTEREST_RATE_YEARLY)**(1/12) - 1; 
            
            const maxLoanFromBank = property.listPrice * MAX_LOAN_TO_VALUE;
            const maxAffordablePayment = client.income * MAX_DEBT_TO_INCOME;

            const requiredPaymentForMaxLoan = (maxLoanFromBank * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -finalTerm));
            const isCompatible = requiredPaymentForMaxLoan <= maxAffordablePayment;
            let approvedLoanAmount, requiredDownPayment;

            if (isCompatible) {
                approvedLoanAmount = maxLoanFromBank;
                requiredDownPayment = property.listPrice - approvedLoanAmount;
            } else {
                approvedLoanAmount = (maxAffordablePayment / monthlyInterestRate) * (1 - Math.pow(1 + monthlyInterestRate, -finalTerm));
                requiredDownPayment = property.listPrice - approvedLoanAmount;
            }

            return {
                isCompatible, clientIncome: client.income, propertyValue: property.listPrice,
                maxAffordablePayment, requiredPaymentForMaxLoan, approvedLoanAmount, requiredDownPayment,
                finalTerm: Math.floor(finalTerm), standardDownPayment: property.listPrice * (1 - MAX_LOAN_TO_VALUE)
            };
        };

        const getFinancingAnalysisHtml = (analysis, clientName, propertyName) => {
             if (analysis.error) {
                return `<div class="analysis-result"><p class="highlight-danger">${analysis.error}</p></div>`;
            }
            
            const resultClass = analysis.isCompatible ? 'highlight-success' : 'highlight-danger';
            const resultText = analysis.isCompatible ? 'RENDA COMPATÍVEL' : 'RENDA INSUFICIENTE PARA FINANCIAMENTO DE 80%';

            return `
                <div class="analysis-result">
                    <h4>Análise para <strong>${clientName}</strong> | Imóvel: <strong>${propertyName}</strong></h4><hr>
                    <p><strong>Valor do Imóvel:</strong> ${formatCurrency(analysis.propertyValue)}</p>
                    <p><strong>Renda do Cliente:</strong> ${formatCurrency(analysis.clientIncome)}</p>
                    <p><strong>Parcela Máxima Suportada (30%):</strong> ${formatCurrency(analysis.maxAffordablePayment)}</p>
                    <p><strong>Prazo Máximo de Financiamento:</strong> ${analysis.finalTerm} meses (${Math.floor(analysis.finalTerm / 12)} anos)</p><hr>
                    <h4>Resultado da Simulação</h4>
                    <p><strong>Parcela Estimada para 80% do Imóvel:</strong> ${formatCurrency(analysis.requiredPaymentForMaxLoan)}</p>
                    <p><strong>Resultado:</strong> <span class="${resultClass}">${resultText}</span></p><br>
                    <p><strong>Valor Máximo de Financiamento Aprovado:</strong> ${formatCurrency(analysis.approvedLoanAmount)}</p>
                    <p><strong>ENTRADA ESTIMADA NECESSÁRIA:</strong> <strong class="${resultClass}">${formatCurrency(analysis.requiredDownPayment)}</strong></p>
                    ${!analysis.isCompatible ? `<p><small>(A entrada padrão de 20% seria de ${formatCurrency(analysis.standardDownPayment)})</small></p>` : ''}
                </div>
            `;
        };
        
        const handleFinancingAnalysis = (clientId) => {
            const client = db.clients.find(c => c.id == clientId);
            const property = db.properties.find(p => p.id == client.propertyId);

            if (!property) {
                alert('Este cliente não está associado a um imóvel de interesse. Edite o cadastro do cliente para selecionar um.');
                return;
            }
            
            const analysis = calculateFinancing(client, property);
            const modalHtml = getFinancingAnalysisHtml(analysis, client.name, property.name);
            openModal('Análise de Financiamento', modalHtml, 'analysis', null, false);
        };
        
        // ==========================================
        // GESTÃO FINANCEIRA & BI
        // ==========================================
        const renderFinancialBI = () => {
            const container = document.getElementById('financial-content');
            
            const saleStage = db.funnelStages.find(s => s.probability === 100);
            if (!saleStage) {
                container.innerHTML = '<p>Erro: Configure uma etapa do funil com 100% de probabilidade para "Venda".</p>';
                return;
            }

            const sales = db.clients.filter(c => c.stageId === saleStage.id);
            const realizedRevenue = sales.reduce((sum, client) => {
                const commission = client.commission || db.settings.defaultCommission;
                const prop = db.properties.find(p => p.id == client.propertyId);
                const value = prop ? prop.listPrice : client.propertyValue;
                return sum + (value * commission / 100);
            }, 0);

            const totalPotential = db.clients.filter(c => c.stageId !== saleStage.id)
                .reduce((sum, client) => {
                    const prop = db.properties.find(p => p.id == client.propertyId);
                    const value = prop ? prop.listPrice : client.propertyValue;
                    return sum + (value * (client.commission || db.settings.defaultCommission) / 100);
                }, 0);
            
            const weightedForecast = db.clients.filter(c => c.stageId !== saleStage.id)
                .reduce((sum, client) => {
                    const stage = db.funnelStages.find(s => s.id === client.stageId);
                    if (!stage) return sum;
                    const commission = client.commission || db.settings.defaultCommission;
                    const prop = db.properties.find(p => p.id == client.propertyId);
                    const value = prop ? prop.listPrice : client.propertyValue;
                    const potential = value * commission / 100;
                    return sum + (potential * (stage.probability / 100));
                }, 0);

            const totalLeads = db.clients.length;
            const conversionRate = totalLeads > 0 ? (sales.length / totalLeads) * 100 : 0;
            const averageTicket = sales.length > 0 ? realizedRevenue / sales.length : 0;
            const revenueGoal = db.settings.goals.revenue || 0;
            const leadsNeeded = (averageTicket > 0 && conversionRate > 0) ? (revenueGoal / (averageTicket * (conversionRate/100))) : 0;

            container.innerHTML = `
                <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-dollar-sign metric-icon"></i>
                        <div>
                            <h3>Faturamento Realizado</h3>
                            <p class="metric-value">${formatCurrency(realizedRevenue)}</p>
                        </div>
                    </div>
                </div>
                <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-balance-scale metric-icon"></i>
                        <div>
                            <h3>Previsão Ponderada</h3>
                            <p class="metric-value">${formatCurrency(weightedForecast)}</p>
                        </div>
                    </div>
                </div>
                <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-gem metric-icon"></i>
                        <div>
                            <h3>Potencial em Aberto</h3>
                            <p class="metric-value">${formatCurrency(totalPotential)}</p>
                        </div>
                    </div>
                </div>
                <div class="financial-card metric-card">
                    <div class="metric-card-content">
                        <i class="fas fa-bullseye metric-icon"></i>
                        <div>
                            <h3>Taxa de Conversão</h3>
                            <p class="metric-value">${conversionRate.toFixed(1)}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="financial-card bi-card">
                    <h3>Inteligência de Negócios</h3>
                    <div class="bi-insight"><strong>Ticket Médio de Comissão:</strong> ${formatCurrency(averageTicket)}</div>
                    <div class="bi-insight"><strong>Previsão de Leads para Atingir a Meta (${formatCurrency(revenueGoal)}):</strong> Você precisa de aproximadamente <strong>${Math.ceil(leadsNeeded)}</strong> novos leads qualificados.</div>
                    <p style="margin-top: 1rem;"><strong>Dica Estratégica:</strong> Monitore as taxas de juros (SELIC) para financiamento imobiliário. Uma queda pode ser uma excelente oportunidade para reativar leads antigos que aguardavam melhores condições de crédito.</p>
                </div>
            `;
        };

        // ==========================================
        // GESTÃO DE CONFIGURAÇÕES
        // ==========================================
        const renderSettings = () => {
            document.getElementById('setting-broker-name').value = db.settings.brokerName;
            document.getElementById('setting-broker-creci').value = db.settings.brokerCreci;
            document.getElementById('setting-broker-phone').value = db.settings.brokerPhone;
            document.getElementById('setting-leads-goal').value = db.settings.goals.leads;
            document.getElementById('setting-revenue-goal').value = db.settings.goals.revenue;
            document.getElementById('setting-default-commission').value = db.settings.defaultCommission;
            renderFunnelEditor();
        };

        document.getElementById('save-broker-info').addEventListener('click', () => {
            db.settings.brokerName = document.getElementById('setting-broker-name').value;
            db.settings.brokerCreci = document.getElementById('setting-broker-creci').value;
            db.settings.brokerPhone = document.getElementById('setting-broker-phone').value;
            const logoFile = document.getElementById('setting-logo-upload').files[0];
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.settings.logoUrl = e.target.result;
                    saveData();
                    updateHeader();
                    alert('Dados do corretor e logo salvos!');
                };
                reader.readAsDataURL(logoFile);
            } else {
                saveData();
                updateHeader();
                alert('Dados do corretor salvos!');
            }
        });

        document.getElementById('save-goals').addEventListener('click', () => {
            db.settings.goals.leads = parseInt(document.getElementById('setting-leads-goal').value) || 0;
            db.settings.goals.revenue = parseFloat(document.getElementById('setting-revenue-goal').value) || 0;
            db.settings.defaultCommission = parseFloat(document.getElementById('setting-default-commission').value) || 5;
            saveData();
            alert('Metas salvas com sucesso!');
        });
        
        // Funil Arrastável
        const renderFunnelEditor = () => {
            const container = document.getElementById('funnel-editor');
            container.innerHTML = '';
            db.funnelStages.forEach(stage => {
                container.innerHTML += `
                    <div class="stage-item" data-id="${stage.id}" draggable="true">
                        <i class="fas fa-grip-vertical" style="margin-right: 10px; color: #ccc;"></i>
                        <input type="text" class="stage-name-input" value="${stage.name}">
                        <input type="number" class="stage-prob-input" value="${stage.probability}" min="0" max="100"> %
                        <button class="delete-stage-btn"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        };
        
        const funnelEditor = document.getElementById('funnel-editor');
        let draggedItem = null;

        funnelEditor.addEventListener('dragstart', e => {
            draggedItem = e.target.closest('.stage-item');
            draggedItem.classList.add('dragging');
        });

        funnelEditor.addEventListener('dragend', e => {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        });

        funnelEditor.addEventListener('dragover', e => {
            e.preventDefault();
            const container = funnelEditor;
            const afterElement = getDragAfterElement(container, e.clientY);
            const currentDragging = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(currentDragging);
            } else {
                container.insertBefore(currentDragging, afterElement);
            }
        });

        funnelEditor.addEventListener('drop', e => {
            const newOrderIds = [...funnelEditor.querySelectorAll('.stage-item')].map(item => Number(item.dataset.id));
            db.funnelStages.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
            saveData();
            renderFunnelFilters(); // Atualiza os filtros de cliente
        });
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.stage-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        document.getElementById('add-stage-btn').addEventListener('click', () => {
            const name = document.getElementById('new-stage-name').value;
            const prob = parseInt(document.getElementById('new-stage-prob').value);
            if (!name || isNaN(prob)) {
                alert('Preencha o nome e a probabilidade da etapa.'); return;
            }
            db.funnelStages.push({ id: Date.now(), name, probability: prob });
            saveData();
            renderFunnelEditor();
            document.getElementById('new-stage-name').value = '';
            document.getElementById('new-stage-prob').value = '';
        });

        funnelEditor.addEventListener('click', e => {
            if (e.target.closest('.delete-stage-btn')) {
                const id = e.target.closest('.stage-item').dataset.id;
                db.funnelStages = db.funnelStages.filter(s => s.id != id);
                saveData();
                renderFunnelEditor();
            }
        });
        
        funnelEditor.addEventListener('change', e => {
             if (e.target.classList.contains('stage-name-input') || e.target.classList.contains('stage-prob-input')) {
                const id = e.target.closest('.stage-item').dataset.id;
                const stage = db.funnelStages.find(s => s.id == id);
                if (e.target.classList.contains('stage-name-input')) {
                    stage.name = e.target.value;
                } else {
                    stage.probability = parseInt(e.target.value);
                }
                saveData();
             }
        });

        // Data Management
        document.getElementById('clear-system-btn').addEventListener('click', () => {
            if (confirm('ATENÇÃO! Isso apagará TODOS os dados do sistema permanentemente. Deseja continuar?')) {
                dexieDb.delete().then(() => {
                    alert("Banco de dados apagado com sucesso.");
                    location.reload();
                }).catch((err) => {
                    console.error("Não foi possível apagar o banco de dados", err);
                    alert("Ocorreu um erro ao tentar limpar o sistema.");
                });
            }
        });

        document.getElementById('delete-duplicates-btn').addEventListener('click', () => {
            const uniqueClients = [];
            const seenPhones = new Set();
            db.clients.forEach(client => {
                if (!client.phone) { uniqueClients.push(client); return; }
                const phone = client.phone.replace(/\D/g, '');
                if (!seenPhones.has(phone)) {
                    seenPhones.add(phone);
                    uniqueClients.push(client);
                }
            });
            const removedCount = db.clients.length - uniqueClients.length;
            db.clients = uniqueClients;
            saveData();
            alert(`${removedCount} cliente(s) duplicado(s) foram removidos.`);
            triggerClientTableRender();
        });

        document.getElementById('export-backup-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_crm_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-backup-btn').addEventListener('click', () => {
             document.getElementById('import-backup').click();
        });
        
        document.getElementById('import-backup').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedDb = JSON.parse(event.target.result);
                    if (confirm('Isso substituirá todos os dados atuais. Deseja continuar?')) {
                        db = importedDb;
                        saveData();
                        location.reload();
                    }
                } catch (err) {
                    alert('Erro ao ler o arquivo de backup. Verifique se o arquivo é válido.');
                }
            };
            reader.readAsText(file);
        });
        
        document.getElementById('download-template-btn').addEventListener('click', () => {
            const clientTemplate = [{
                nome: "Exemplo Cliente", contato: "5582999998888", email: "cliente@exemplo.com", 
                cpf: "123.456.789-00", data_nascimento: "1990-01-15", renda: 5000, 
                valor_imovel_pretendido: 300000, comissao_personalizada: 6, origem: "patrocinado"
            }];
            const propertyTemplate = [{
                nome: "Exemplo Imóvel", localizacao: "Bairro Exemplo, Maceió",
                valor_tabela: 450000, valor_avaliacao: 460000, data_entrega: "2026-12-31",
                link: "https://site.com/imovel", descricao: "Apartamento de 3 quartos."
            }];
            
            const wb = XLSX.utils.book_new();
            const wsClients = XLSX.utils.json_to_sheet(clientTemplate);
            const wsProperties = XLSX.utils.json_to_sheet(propertyTemplate);
            XLSX.utils.book_append_sheet(wb, wsClients, "Clientes");
            XLSX.utils.book_append_sheet(wb, wsProperties, "Imoveis");
            XLSX.writeFile(wb, "modelo_importacao_crm.xlsx");
        });

        document.getElementById('import-btn').addEventListener('click', () => {
            const fileInput = document.getElementById('import-excel');
            const file = fileInput.files[0];
            const type = document.getElementById('import-type').value;
            if (!file) { alert('Selecione um arquivo para importar.'); return; }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates:true });
                    const sheetName = type === 'clients' ? "Clientes" : "Imoveis";
                    const worksheet = workbook.Sheets[sheetName];
                    if (!worksheet) { alert(`Aba "${sheetName}" não encontrada no arquivo.`); return; }
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if (type === 'clients') {
                        json.forEach(row => {
                            db.clients.push({
                                id: Date.now() + Math.random(), name: row.nome, phone: String(row.contato || ''), email: row.email,
                                cpf: String(row.cpf || ''), birthdate: row.data_nascimento, income: row.renda,
                                propertyValue: row.valor_imovel_pretendido, commission: row.comissao_personalizada,
                                leadSource: row.origem,
                                stageId: db.funnelStages[0]?.id || null, notes: ''
                            });
                        });
                    } else {
                         json.forEach(row => {
                            db.properties.push({
                                id: Date.now() + Math.random(), name: row.nome, location: row.localizacao,
                                listPrice: row.valor_tabela, evalPrice: row.valor_avaliacao, deliveryDate: row.data_entrega,
                                link: row.link, description: row.descricao
                            });
                        });
                    }
                    saveData();
                    alert(`${json.length} item(ns) importado(s) com sucesso!`);
                    
                    if (type === 'clients') { switchPanel('clients'); } else { switchPanel('properties'); }
                } catch(error) {
                    console.error("Erro na importação:", error);
                    alert("Ocorreu um erro ao importar a planilha. Verifique o formato do arquivo e os nomes das colunas.");
                } finally {
                    fileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // ==========================================
        // GERAÇÃO DE CONTEÚDO DE FICHAS E PDFS
        // ==========================================
        const getClientDetailsHtml = (id) => {
            const client = db.clients.find(c => c.id == id);
            const stage = db.funnelStages.find(s => s.id === client.stageId);
            const property = db.properties.find(p => p.id == client.propertyId);
            const propertyValue = property ? property.listPrice : client.propertyValue;
            const commission = client.commission || db.settings.defaultCommission;
            const commissionValue = (propertyValue * commission) / 100;
            const events = db.events.filter(e => e.clientId == id);
            
            let financingHtml = '';
            if (property) {
                const analysis = calculateFinancing(client, property);
                const analysisResultHtml = getFinancingAnalysisHtml(analysis, client.name, property.name)
                                           .replace(/<strong class="[^"]*">/g, '<strong>')
                                           .replace(/<span class="[^"]*">/g, '<strong><span>')
                                           .replace(/<\/span>/g, '</span></strong>');
                financingHtml = `<h3>Análise de Financiamento</h3>${analysisResultHtml}`;
            }

            return `
                <h3>Dados Pessoais</h3>
                <p><strong>Nome:</strong> ${client.name || ''}</p>
                <p><strong>Contato:</strong> ${client.phone || ''}</p>
                <p><strong>Email:</strong> ${client.email || ''}</p>
                <p><strong>CPF:</strong> ${client.cpf || ''}</p>
                <p><strong>Data de Nascimento:</strong> ${formatDate(client.birthdate)}</p>
                
                <h3>Dados Financeiros e de Interesse</h3>
                <p><strong>Renda Declarada:</strong> ${formatCurrency(client.income)}</p>
                <p><strong>Origem do Lead:</strong> ${client.leadSource || 'Não informada'}</p>
                <p><strong>Imóvel de Interesse:</strong> ${property ? property.name : 'Não selecionado'}</p>
                <p><strong>Valor do Imóvel:</strong> ${formatCurrency(propertyValue)}</p>
                <p><strong>Comissão (Potencial):</strong> ${formatCurrency(commissionValue)} (${commission}%)</p>
                
                <h3>Status no Funil</h3>
                <p><strong>Etapa Atual:</strong> ${stage ? stage.name : 'Não definida'}</p>
                
                ${financingHtml}

                <h3>Histórico de Compromissos</h3>
                ${events.length > 0 ? events.map(e => `<p>${formatDate(e.date)} às ${e.time || ''} - ${e.title}</p>`).join('') : '<p>Nenhum compromisso registrado.</p>'}
            `;
        };

        const getPropertyDetailsHtml = (id, forClient = false) => {
            const prop = db.properties.find(p => p.id == id);
            const requiredIncome = (prop.listPrice && prop.listPrice > 0)
                ? calculateMinimumIncomeForProperty(prop.listPrice)
                : 0;

            return `
                <h3>${prop.name || ''}</h3>
                <p><strong>Localização:</strong> ${prop.location || ''}</p>
                <p><strong>Valor de Tabela:</strong> ${formatCurrency(prop.listPrice)}</p>
                ${!forClient ? `<p><strong>Valor de Avaliação:</strong> ${formatCurrency(prop.evalPrice)}</p>` : ''}
                ${requiredIncome > 0 ? `<p><strong>Renda Mínima Necessária (Estimada):</strong> ${formatCurrency(requiredIncome)}</p>` : ''}
                <p><strong>Data de Entrega Prevista:</strong> ${formatDate(prop.deliveryDate)}</p>
                ${prop.link ? `<p><strong>Link Adicional:</strong> <a href="${prop.link}" target="_blank" title="Abrir link"><i class="fas fa-link"></i></a></p>` : ''}
                <h3>Descrição</h3>
                <p>${(prop.description || '').replace(/\n/g, '<br>')}</p>
            `;
        };
        
        const generatePDF = (htmlContent, fileName) => {
            const { jsPDF } = window.jspdf;
            const pdfContainer = document.getElementById('pdf-generator');
            pdfContainer.innerHTML = htmlContent;
            
            html2canvas(pdfContainer, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
                pdfContainer.innerHTML = '';
            }).catch(err => {
                console.error("Erro ao gerar PDF: ", err);
                alert("Não foi possível gerar o PDF.");
                pdfContainer.innerHTML = '';
            });
        };
        
        const generateClientPDF = (id) => {
            const client = db.clients.find(c => c.id == id);
            const content = `<h1>Ficha do Cliente</h1>` + getClientDetailsHtml(id);
            generatePDF(content, `Ficha_Cliente_${client.name}.pdf`);
        };

        const generatePropertyPDF = (id) => {
            const prop = db.properties.find(p => p.id == id);
            const forClient = confirm('Gerar versão para o cliente? (Ocultará valor de avaliação)');
            const content = `<h1>Ficha do Imóvel</h1>` + getPropertyDetailsHtml(id, forClient);
            generatePDF(content, `Ficha_Imovel_${prop.name}.pdf`);
        };
        
        // ==========================================
        // LÓGICA DE SALVAMENTO DO MODAL
        // ==========================================
        modalSaveBtn.addEventListener('click', () => {
            if (currentEntityType === 'client') {
                const clientData = {
                    id: currentEditingId || Date.now() + Math.random(),
                    name: document.getElementById('client-name').value, phone: document.getElementById('client-phone').value,
                    email: document.getElementById('client-email').value, cpf: document.getElementById('client-cpf').value,
                    birthdate: document.getElementById('client-birthdate').value,
                    income: parseFloat(document.getElementById('client-income').value) || 0,
                    propertyValue: parseFloat(document.getElementById('client-property-value').value) || 0,
                    commission: parseFloat(document.getElementById('client-commission').value) || null,
                    stageId: parseInt(document.getElementById('client-stageId').value),
                    leadSource: document.getElementById('client-lead-source').value,
                    propertyId: document.getElementById('client-propertyId').value,
                    notes: document.getElementById('client-notes').value
                };
                if(currentEditingId) {
                    const index = db.clients.findIndex(c => c.id == currentEditingId);
                    if (index > -1) db.clients[index] = clientData;
                } else { db.clients.push(clientData); }
                triggerClientTableRender();
            }
            if (currentEntityType === 'property') {
                const propData = {
                    id: currentEditingId || Date.now() + Math.random(),
                    name: document.getElementById('prop-name').value, location: document.getElementById('prop-location').value,
                    listPrice: parseFloat(document.getElementById('prop-list-price').value) || 0,
                    evalPrice: parseFloat(document.getElementById('prop-eval-price').value) || 0,
                    deliveryDate: document.getElementById('prop-delivery-date').value,
                    link: document.getElementById('prop-link').value,
                    description: document.getElementById('prop-description').value,
                    images: tempPropertyImages,
                };
                 if(currentEditingId) {
                    const index = db.properties.findIndex(p => p.id == currentEditingId);
                    if (index > -1) db.properties[index] = propData;
                } else { db.properties.push(propData); }
                renderPropertiesTable();
            }
             if (currentEntityType === 'event') {
                const eventData = {
                    id: currentEditingId || Date.now() + Math.random(),
                    title: document.getElementById('event-title').value,
                    clientId: document.getElementById('event-client').value,
                    date: document.getElementById('event-date').value,
                    time: document.getElementById('event-time').value,
                    description: document.getElementById('event-description').value,
                    completed: currentEditingId ? db.events.find(e=>e.id==currentEditingId).completed : false,
                };
                 if(currentEditingId) {
                    const index = db.events.findIndex(e => e.id == currentEditingId);
                     if (index > -1) db.events[index] = eventData;
                } else { db.events.push(eventData); }
                renderAgendaCalendar();
            }
            saveData();
            closeModal();
        });

        // ==========================================
        // DASHBOARD
        // ==========================================
        const renderDashboard = () => {
            const container = document.getElementById('dashboard-content');
            
            const leadsThisMonth = db.clients.length;
            const leadsGoal = db.settings.goals.leads || 1;
            
            const funnelSummary = db.funnelStages.map(stage => {
                const count = db.clients.filter(c => c.stageId === stage.id).length;
                return `<li>${stage.name}: <strong>${count}</strong></li>`;
            }).join('');

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const upcomingEvents = db.events
                .filter(e => {
                    if (e.completed || !e.date) return false;
                    const eventDate = new Date(e.date + 'T00:00:00');
                    return eventDate >= today;
                })
                .sort((a,b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5)
                .map(e => `<li>${e.title} - ${formatDate(e.date)}</li>`).join('');

            container.innerHTML = `
                <div class="dashboard-card">
                    <h3>Meta de Leads do Mês</h3>
                    <p>${leadsThisMonth} / ${leadsGoal} Leads</p>
                    <progress value="${leadsThisMonth}" max="${leadsGoal}" style="width: 100%; height: 20px;"></progress>
                </div>
                <div class="dashboard-card">
                    <h3>Resumo do Funil</h3>
                    <ul style="list-style: none; padding: 0;">${funnelSummary}</ul>
                </div>
                <div class="dashboard-card">
                    <h3>Próximos Compromissos</h3>
                    <ul style="list-style: none; padding: 0;">${upcomingEvents || '<li>Nenhum compromisso futuro.</li>'}</ul>
                </div>
            `;
            
            renderFunnelChart();
        };
        
        const renderFunnelChart = () => {
            const container = document.getElementById('funnel-chart');
            container.innerHTML = '';

            const funnelData = db.funnelStages.map(stage => ({
                name: stage.name,
                count: db.clients.filter(c => c.stageId === stage.id).length
            }));

            const maxCount = Math.max(...funnelData.map(d => d.count), 1);

            funnelData.forEach(stage => {
                const heightPercentage = (stage.count / maxCount) * 100;
                container.innerHTML += `
                    <div class="funnel-bar-wrapper">
                        <div class="funnel-bar" style="height: ${heightPercentage}%;">
                            <span class="funnel-bar-label">${stage.count}</span>
                        </div>
                        <div class="funnel-stage-name">${stage.name}</div>
                    </div>
                `;
            });
        };
        
        // ==========================================
        // FUNÇÕES DE EXPORTAÇÃO
        // ==========================================
        document.getElementById('export-clients-excel').addEventListener('click', () => {
            const searchValue = document.getElementById('client-search').value;
            const stageValue = document.querySelector('.funnel-filter-btn.active')?.dataset.stageId;
            const sourceValue = document.getElementById('client-source-filter').value;

            let filteredClients = db.clients.filter(c => 
                (c.name || '').toLowerCase().includes(searchValue.toLowerCase()) || 
                (c.phone || '').includes(searchValue) || 
                (c.cpf || '').includes(searchValue)
            );
            if (stageValue && stageValue !== 'all') {
                filteredClients = filteredClients.filter(c => c.stageId == stageValue);
            }
            if (sourceValue && sourceValue !== 'all') {
                filteredClients = filteredClients.filter(c => c.leadSource === sourceValue);
            }

            const dataToExport = filteredClients.map(client => {
                const stage = db.funnelStages.find(s => s.id === client.stageId);
                const property = db.properties.find(p => p.id == client.propertyId);
                const propertyValue = property ? property.listPrice : client.propertyValue;
                const commission = client.commission || db.settings.defaultCommission;
                const commissionValue = (propertyValue * commission) / 100;

                return {
                    "Nome": client.name,
                    "Contato": client.phone,
                    "Email": client.email,
                    "CPF": client.cpf,
                    "Data de Nascimento": client.birthdate ? formatDate(client.birthdate) : '',
                    "Renda": client.income,
                    "Etapa do Funil": stage ? stage.name : 'N/A',
                    "Origem do Lead": client.leadSource || 'N/A',
                    "Imóvel de Interesse": property ? property.name : '',
                    "Valor do Imóvel (R$)": propertyValue,
                    "Comissão (%)": commission,
                    "Valor da Comissão (R$)": commissionValue
                };
            });
            
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Clientes");
            XLSX.writeFile(workbook, "lista_de_clientes_filtrada.xlsx");
        });

        document.getElementById('export-properties-excel').addEventListener('click', () => {
            const dataToExport = db.properties.map(prop => ({
                "Nome do Imóvel": prop.name,
                "Localização": prop.location,
                "Valor de Tabela (R$)": prop.listPrice,
                "Valor de Avaliação (R$)": prop.evalPrice,
                "Data de Entrega": prop.deliveryDate ? formatDate(prop.deliveryDate) : '',
                "Link": prop.link,
                "Descrição": prop.description
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Imoveis");
            XLSX.writeFile(workbook, "lista_de_imoveis.xlsx");
        });
        
        // ==========================================
        // NOVO: RELATÓRIO DE FUNIL E ANÁLISE
        // ==========================================
        const updatePerformanceSnapshot = async () => {
            const now = new Date();
            const currentPeriod = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const snapshotExists = db.performanceSnapshots.some(s => s.period === currentPeriod);

            if (!snapshotExists) {
                const saleStage = db.funnelStages.find(s => s.probability === 100);
                const totalClients = db.clients.length;
                const totalSales = saleStage ? db.clients.filter(c => c.stageId === saleStage.id).length : 0;
                const conversionRate = totalClients > 0 ? (totalSales / totalClients) * 100 : 0;
                
                const realizedRevenue = (saleStage ? db.clients.filter(c => c.stageId === saleStage.id) : []).reduce((sum, client) => {
                    const commission = client.commission || db.settings.defaultCommission;
                    const prop = db.properties.find(p => p.id == client.propertyId);
                    const value = prop ? prop.listPrice : client.propertyValue;
                    return sum + (value * commission / 100);
                }, 0);

                const newSnapshot = {
                    period: currentPeriod,
                    metrics: {
                        totalClients,
                        totalSales,
                        conversionRate,
                        realizedRevenue
                    }
                };
                db.performanceSnapshots.push(newSnapshot);
                await saveData();
                console.log('Novo snapshot de performance salvo para o período:', currentPeriod);
            }
        };

        const generateFunnelReportData = () => {
            // 1. Cálculos do estado atual
            const saleStage = db.funnelStages.find(s => s.probability === 100);
            const totalClients = db.clients.length;
            const totalSales = saleStage ? db.clients.filter(c => c.stageId === saleStage.id).length : 0;
            const conversionRate = totalClients > 0 ? (totalSales / totalClients) * 100 : 0;
            
            const realizedRevenue = (saleStage ? db.clients.filter(c => c.stageId === saleStage.id) : []).reduce((sum, client) => {
                const commission = client.commission || db.settings.defaultCommission;
                const prop = db.properties.find(p => p.id == client.propertyId);
                const value = prop ? prop.listPrice : client.propertyValue;
                return sum + (value * commission / 100);
            }, 0);

            const weightedForecast = db.clients.filter(c => saleStage && c.stageId !== saleStage.id)
                .reduce((sum, client) => {
                    const stage = db.funnelStages.find(s => s.id === client.stageId);
                    if (!stage) return sum;
                    const commission = client.commission || db.settings.defaultCommission;
                    const prop = db.properties.find(p => p.id == client.propertyId);
                    const value = prop ? prop.listPrice : client.propertyValue;
                    return sum + ((value * commission / 100) * (stage.probability / 100));
                }, 0);

            // 2. Projeções de Atendimento
            const clientsInFunnel = db.clients.filter(c => saleStage && c.stageId !== saleStage.id).length;
            // Assumindo uma média de 2 contatos por cliente por mês para mantê-lo aquecido
            const monthlyInteractions = clientsInFunnel * 2;
            const weeklyInteractions = monthlyInteractions / 4;
            const dailyInteractions = monthlyInteractions / 22; // Dias úteis

            // 3. Análise Histórica
            const now = new Date();
            const currentPeriod = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const lastMonth = new Date(now.setMonth(now.getMonth() - 1));
            const previousPeriod = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
            
            const currentSnapshot = { period: 'Atual', metrics: { totalClients, totalSales, conversionRate, realizedRevenue } };
            const previousSnapshot = db.performanceSnapshots.find(s => s.period === previousPeriod) || { metrics: { totalClients: 0, totalSales: 0, conversionRate: 0, realizedRevenue: 0 } };

            // 4. Análise Crítica e Estratégias
            let analysisHtml = '';
            const convDiff = currentSnapshot.metrics.conversionRate - previousSnapshot.metrics.conversionRate;
            if (convDiff > 1) {
                analysisHtml += `<p class="highlight-success"><strong>Parabéns!</strong> Sua taxa de conversão geral aumentou em ${convDiff.toFixed(1)} pontos percentuais em relação ao mês anterior. Continue o excelente trabalho nutrindo seus leads e agendando visitas de qualidade.</p>`;
            } else if (convDiff < -1) {
                analysisHtml += `<p class="highlight-danger"><strong>Atenção:</strong> Sua taxa de conversão geral caiu ${Math.abs(convDiff).toFixed(1)} pontos percentuais. É um bom momento para revisar o processo. Será que os leads estão sendo qualificados corretamente no início? O tempo de resposta está rápido o suficiente?</p>`;
            } else {
                 analysisHtml += `<p>Sua taxa de conversão geral se manteve estável. Busque otimizar uma das etapas do funil este mês para ver um impacto positivo nos resultados.</p>`;
            }

            const strategies = `
                <h4><i class="fas fa-lightbulb"></i> Estratégias para Aumentar a Conversão</h4>
                <ul>
                    <li><strong>Para a etapa de 'Lead':</strong> A "Golden Hour" é crucial. Tente fazer o primeiro contato em até 1 hora após o recebimento do lead. A velocidade aumenta drasticamente a chance de qualificação. Use uma mensagem de saudação rápida via WhatsApp para "marcar território".</li>
                    <li><strong>Para 'Contato Realizado' -> 'Visita Agendada':</strong> Foque em qualificar o cliente na ligação. Entenda a real necessidade, capacidade financeira e o momento de compra. Use a técnica "SPIN Selling": faça perguntas sobre <strong>S</strong>ituação, <strong>P</strong>roblema, <strong>I</strong>mplicação e <strong>N</strong>ecessidade de solução. Não tente "vender" o imóvel, venda a visita como o próximo passo lógico para resolver o problema dele.</li>
                    <li><strong>Para 'Visita' -> 'Proposta':</strong> Durante a visita, seja um consultor, não um vendedor. Ouça mais do que fala. Ao final, se o cliente demonstrou interesse, agende o próximo passo ali mesmo: "Excelente! O próximo passo é formalizarmos uma proposta. Podemos nos falar amanhã às 10h para eu apresentar os detalhes?". Isso cria compromisso.</li>
                    <li><strong>Captação de Leads:</strong> Diversifique suas fontes. Além dos portais, invista em tráfego pago (Instagram/Facebook Ads) direcionado para um público específico na sua região. Crie parcerias com arquitetos, advogados de família e outros profissionais que lidam com pessoas em momentos de mudança de vida.</li>
                </ul>`;

            return { currentSnapshot, previousSnapshot, weightedForecast, dailyInteractions, weeklyInteractions, monthlyInteractions, analysisHtml, strategies };
        };
        
        const getFunnelReportHtml = () => {
            const data = generateFunnelReportData();
            
            const formatChange = (current, previous) => {
                const diff = current - previous;
                if (diff > 0) return `<span style="color:var(--success-color);">(+${diff.toFixed(1)})</span>`;
                if (diff < 0) return `<span style="color:var(--danger-color);">(${diff.toFixed(1)})</span>`;
                return `<span>(0)</span>`;
            };

            return `
                <div class="report-section">
                    <h3>Análise de Desempenho (vs. Mês Anterior)</h3>
                    <div class="report-grid">
                        <div class="report-card">
                            <div class="value">${data.currentSnapshot.metrics.totalClients.toFixed(0)}</div>
                            <div class="label">Total de Clientes ${formatChange(data.currentSnapshot.metrics.totalClients, data.previousSnapshot.metrics.totalClients)}</div>
                        </div>
                        <div class="report-card">
                            <div class="value">${data.currentSnapshot.metrics.conversionRate.toFixed(1)}%</div>
                            <div class="label">Taxa de Conversão ${formatChange(data.currentSnapshot.metrics.conversionRate, data.previousSnapshot.metrics.conversionRate)}</div>
                        </div>
                        <div class="report-card">
                            <div class="value">${formatCurrency(data.currentSnapshot.metrics.realizedRevenue)}</div>
                            <div class="label">Faturamento Realizado ${formatChange(data.currentSnapshot.metrics.realizedRevenue, data.previousSnapshot.metrics.realizedRevenue)}</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>Projeções com Base no Funil Atual</h3>
                    <div class="report-grid">
                         <div class="report-card">
                            <div class="value">${formatCurrency(data.weightedForecast)}</div>
                            <div class="label">Faturamento Previsto (Ponderado)</div>
                        </div>
                         <div class="report-card">
                            <div class="value">${data.dailyInteractions.toFixed(1)}</div>
                            <div class="label">Atendimentos/Dia</div>
                        </div>
                        <div class="report-card">
                            <div class="value">${data.weeklyInteractions.toFixed(1)}</div>
                            <div class="label">Atendimentos/Semana</div>
                        </div>
                        <div class="report-card">
                            <div class="value">${data.monthlyInteractions.toFixed(1)}</div>
                            <div class="label">Atendimentos/Mês</div>
                        </div>
                    </div>
                </div>

                 <div class="report-section">
                    <h3>Análise Crítica</h3>
                    ${data.analysisHtml}
                </div>

                <div class="report-section">
                     ${data.strategies}
                </div>
            `;
        };
        
        document.getElementById('view-funnel-report-btn').addEventListener('click', () => {
            const reportHtml = getFunnelReportHtml();
            openModal('Relatório de Funil e Desempenho', reportHtml, 'funnel-report', null, false);
        });

        document.getElementById('download-funnel-report-btn').addEventListener('click', () => {
             const reportHtml = `<h1>Relatório de Funil e Desempenho</h1>` + getFunnelReportHtml();
             generatePDF(reportHtml, `Relatorio_Funil_${new Date().toISOString().slice(0,10)}.pdf`);
        });
    
        // ==========================================
        // INICIALIZAÇÃO DO SISTEMA
        // ==========================================
        const init = async () => {
            await loadData();
            await updatePerformanceSnapshot(); // Garante que há um snapshot para o mês atual
            updateHeader();
            switchPanel('dashboard');
            setTimeout(checkStartupAlerts, 10000); // Aciona o alerta 10s após carregar
        };
    
        init();
    });
    </script>
</body>
</html>
